# Arquivo: .github/workflows/docker-advanced.yml
# OBJETIVO: Pipeline ultra-avanÃ§ado para abelinha-v2
# ATUALIZAÃÃO: Adicionado job de notificaÃ§Ã£o no Discord

name: Ultra Advanced CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '20'
  DOCKER_REPO: ${{ secrets.DOCKER_USERNAME }}/abelhinha-v2

jobs:
  # ------------------------------------
  # 1. Lint
  # ------------------------------------
  lint:
    name: 1. Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  # ------------------------------------
  # 2. Test
  # ------------------------------------
  test:
    name: 2. Test Node.js App
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm test -- --coverage
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # ------------------------------------
  # 3. Build & Push Docker
  # ------------------------------------
  docker-build-push:
    name: 3. Build & Push Docker
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Extract version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REPO }}
          tags: |
            type=raw,value=latest,enable=true
            type=raw,value=v${{ steps.version.outputs.version }},enable=true
      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ------------------------------------
  # 4. Notificação (JOB ATUALIZADO)
  # ------------------------------------
  notify:
    name: 4. Notify Result
    runs-on: ubuntu-latest
    needs: [lint, test, docker-build-push]
    if: always() # Roda sempre, mesmo se o build falhar
    steps:
      # Ação de notificação de FALHA
      - name: Notify Failure on Discord
        uses: r-grid/action-discord-notification@v1
        if: ${{ needs.docker-build-push.result != 'success' }}
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
          title: "❌ Build Falhou! (Abelinha-v2)"
          color: "#FF0000" # Vermelho
          description: |
            O pipeline da Abelinha-v2 falhou.
            **Commit:** `${{ github.sha }}`
            **Autor:** `${{ github.actor }}`
            **Link para os Logs:**
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
      # Ação de notificação de SUCESSO
      - name: Notify Success on Discord
        uses: r-grid/action-discord-notification@v1
        if: ${{ needs.docker-build-push.result == 'success' }}
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
          title: "✅ Deploy Concluído! (Abelinha-v2)"
          color: "#00FF00" # Verde
          description: |
            A nova versão da Abelinha-v2 foi construída e enviada para o Docker Hub.
            **Commit:** `${{ github.sha }}`
            **Autor:** `${{ github.actor }}`
            **Link para os Logs:**
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}